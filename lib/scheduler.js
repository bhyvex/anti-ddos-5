/******************************************************************************
 * scheduler.js - process scheduler of the hybridd engine                     *
 * Copyright Â© 2016 Joachim de Koning, Amadeus de Koning                      *
 *                                                                            *
 * This work is licensed under the GPLv3. See the LICENSE files at            *
 * the top-level directory of this distribution for the individual copyright  *
 * holder information and the developer policies on copyright and licensing.  *
 *                                                                            *
 * Unless otherwise agreed in a custom licensing agreement, no part of the    *
 * this software, including this file, may be copied, modified, propagated,   *
 * or distributed except according to the terms contained in the LICENSE      *
 * file.                                                                      *
 *                                                                            *
 * Removal or modification of this copyright notice is prohibited.            *
 *                                                                            *
 ******************************************************************************/

function initialize(){setInterval(function(){var a;for(a in global.hybridd.procqueue)DEBUG&&console.log(" [D] processing engine creating process "+a),seqproc(a,global.hybridd.procqueue[a]),delete global.hybridd.procqueue[a]},50),setInterval(function(){var a,b,c=600;for(a in global.hybridd.proc){var d=procpart(a);b=d[1]>-1&&d[0];var e=null!=global.hybridd.proc[a].timeout?global.hybridd.proc[a].timeout:15e3;"undefined"!=typeof global.hybridd.proc[a]&&(e>0&&global.hybridd.proc[a].started<Date.now()-1e3*c?(DEBUG&&console.log(" [D] processing engine purging process "+a),delete global.hybridd.proc[a]):e>0&&null==global.hybridd.proc[a].stopped&&global.hybridd.proc[a].started<Date.now()-e&&(DEBUG&&console.log(" [D] process "+a+" has timed out"),global.hybridd.proc[a].err=1,global.hybridd.proc[a].info="Process timeout!",global.hybridd.proc[a].busy=!1,global.hybridd.proc[a].stopped=Date.now()))}},1e3)}function subqueue(a,b){return result=!0,"undefined"!=typeof b&&b.length>-1&&(DEBUG&&console.log(" [D] adding "+a+" to processing queue"),initproc(a),global.hybridd.procqueue[a]=b,result=!1),result}function initproc(a,b){if("undefined"==typeof b&&(b={}),0==a){var c=("000"+999*Math.random()).slice(-3);a=Date.now()+c.toString()}return global.hybridd.proc[a]={},global.hybridd.proc[a].err=0,global.hybridd.proc[a].busy=null,global.hybridd.proc[a].step=null,global.hybridd.proc[a].steps=null,global.hybridd.proc[a].subproc=null,global.hybridd.proc[a].progress=0,global.hybridd.proc[a].autoprog=!0,global.hybridd.proc[a].timeout=null,global.hybridd.proc[a].started=Date.now(),global.hybridd.proc[a].stopped=null,global.hybridd.proc[a].request=null,global.hybridd.proc[a].data=null,-1==a.indexOf(".")&&(global.hybridd.proc[a].vars={}),a}function stopproc(a,b){"undefined"==typeof b&&(b={});try{null==global.hybridd.proc[a].stopped?(global.hybridd.proc[a].err="undefined"!=typeof b.err?b.err:0,global.hybridd.proc[a].data="undefined"!=typeof b.data?b.data:null,global.hybridd.proc[a].progress=1,global.hybridd.proc[a].stopped=Date.now()):(DEBUG&&console.log(" [D] ("+a+") process was already stopped"),console.log(" [D] warning: process "+a+" was already stopped"))}catch(b){DEBUG&&console.log(" [D] process "+a+" no longer exists, or cannot be stopped")}}function procpart(a){var b=a.split("."),c={},d=[];d[0]="";var e;for(e=0;e<b.length-1;e++)c[e]=b[e];return d[0]=functions.implode(".",c),d[1]=b[b.length-1],d[1]-1>-1?d[2]=d[0]+"."+(d[1]-1):d[2]=d[0],d}function seqproc(a,b){var c=0;for(global.hybridd.proc[a].step=0,global.hybridd.proc[a].steps=b.length-1,global.hybridd.proc[a].busy=!1,DEBUG&&console.log(" [D] ("+a+") initializing sequence processing for "+(global.hybridd.proc[a].steps+1)+" steps..."),c=0;c<b.length;++c)initproc(a+"."+c),b[c]=b[c].replace('"processID":"'+a+'"','"processID":"'+a+"."+c+'"'),global.hybridd.proc[a+"."+c].request=b[c];seqstep(a,b,0)}function seqstep(processID,subprocesses,step){var runprocess=subprocesses[step];if(1==global.hybridd.proc[processID].busy)1==global.hybridd.proc[processID+"."+step].progress&&(DEBUG&&console.log(" [D] ("+processID+") finished step "+(step+1)+" of "+(global.hybridd.proc[processID].steps+1)),1==global.hybridd.proc[processID].autoprog&&(global.hybridd.proc[processID].progress=global.hybridd.proc[processID].step/global.hybridd.proc[processID].steps),global.hybridd.proc[processID].busy=!1,1==global.hybridd.proc[processID].progress?global.hybridd.proc[processID].stopped=Date.now():global.hybridd.proc[processID].step++),setTimeout(function(){"undefined"!=typeof global.hybridd.proc[processID]&&"undefined"!=typeof global.hybridd.proc[processID].step&&seqstep(processID,subprocesses,global.hybridd.proc[processID].step)},200);else if(1!=global.hybridd.proc[processID].busy&&null==global.hybridd.proc[processID].stopped&&global.hybridd.proc[processID].step<=global.hybridd.proc[processID].steps){global.hybridd.proc[processID].busy=!0,DEBUG&&console.log(" [D] ("+processID+") running step "+(step+1)+" of "+(global.hybridd.proc[processID].steps+1));var prevID=global.hybridd.proc[processID].subproc;if("undefined"!=typeof global.hybridd.proc[prevID])var err="undefined"!=typeof global.hybridd.proc[prevID].err?global.hybridd.proc[prevID].err:1,data="undefined"!=typeof global.hybridd.proc[prevID].data?global.hybridd.proc[prevID].data:null;else var err=null,data=null;var subinsert='{parentID:"'+processID+'",processID:"'+processID+"."+step+'"}';runprocess=subprocesses[step].replace(/peek\(/g,"peek("+subinsert+",").replace(/json\(/g,"json("+subinsert+","),["next","dump","func","time","wait","prwt","stop","jump","test","poke","prog","pass","push","coll"].indexOf(subprocesses[step].substr(0,4))>-1&&(runprocess=runprocess.slice(0,5)+subinsert+","+runprocess.slice(5)),global.hybridd.proc[processID].subproc=processID+"."+step,eval(runprocess),setTimeout(function(){seqstep(processID,subprocesses,global.hybridd.proc[processID].step)},200)}}function func(p,module,funcname,data){DEBUG&&console.log(" [D] ("+p.parentID+") function call to module "+module+" -> "+funcname),"object"!=typeof data&&(data={}),data.processID=p.processID;try{eval("modules.module."+module+".main."+funcname+"("+JSON.stringify(data)+");")}catch(o){DEBUG&&console.log(" [D] ("+p.parentID+") error in call (module "+module+" -> "+funcname+")"+(o?" | "+o:"")),next(p,1,"[func "+module+","+funcname+"]")}}function next(a,b,c){return global.hybridd.proc[a.processID].err="undefined"==typeof b?1:b,global.hybridd.proc[a.processID].busy=!1,global.hybridd.proc[a.processID].progress=1,global.hybridd.proc[a.processID].stopped=Date.now(),global.hybridd.proc[a.processID].data="undefined"!=typeof c?c:"[next]",!0}function dump(a,b){console.log("[D] ("+a.parentID+") dump: "+JSON.stringify(b)),next(a,0,b)}function wait(a,b,c){DEBUG&&console.log(" [D] ("+a.parentID+") waiting at "+(global.hybridd.proc[a.parentID].step+1)+" of "+(global.hybridd.proc[a.parentID].steps+1)),"undefined"==typeof c&&(c="[wait "+b+"]"),global.hybridd.proc[a.parentID].timeout>0&&b<global.hybridd.proc[a.parentID].timeout&&-1!=global.hybridd.proc[a.parentID].timeout&&(global.hybridd.proc[a.parentID].timeout=global.hybridd.proc[a.parentID].timeout+b),global.hybridd.proc[a.processID].timeout>0&&b<global.hybridd.proc[a.processID].timeout&&-1!=global.hybridd.proc[a.processID].timeout&&(global.hybridd.proc[a.processID].timeout=global.hybridd.proc[a.processtID].timeout+b),setTimeout(function(a,b){next(a,0,b)},b,a,c)}function prwt(a,b){var c=500;"undefined"!=typeof global.hybridd.proc[b]&&(global.hybridd.proc[b].progress>=1||global.hybridd.proc[b].stopped>1?next(a,global.hybridd.proc[b].err,{processID:b}):setTimeout(function(a,b){prwt(a,b)},c,a,b),DEBUG&&console.log(" [D] ("+a.parentID+") processwait at "+(global.hybridd.proc[a.parentID].step+1)+" of "+(global.hybridd.proc[a.parentID].steps+1)))}function coll(a,b){DEBUG&&console.log(" [D] ("+a.parentID+") collating subprocess data for "+b+" steps"),"undefined"!=typeof b&&0!=b||(b=global.hybridd.proc[a.parentID].step),b>global.hybridd.proc[a.parentID].step&&(b=global.hybridd.proc[a.parentID].step);for(var c=[],d=global.hybridd.proc[a.parentID].step-b;d<global.hybridd.proc[a.parentID].step;d++)c.push(global.hybridd.proc[a.parentID+"."+d].data);next(a,0,c)}function pass(a,b){DEBUG&&console.log(" [D] ("+a.parentID+") passing subprocess data to parent process"),"undefined"==typeof b&&(b="[pass]"),global.hybridd.proc[a.parentID].data=b,next(a,0,b)}function push(a,b){pass(a,0,b)}function prog(a,b,c,d){DEBUG&&console.log(" [D] ("+a.parentID+") progress reset to "+b+" of "+c),"undefined"==typeof c&&(c=1),"undefined"==typeof d&&(d="[prog "+b+"/"+c+"]"),-1==b?global.hybridd.proc[a.parentID].autoprog=!0:(global.hybridd.proc[a.parentID].progress=b/c,global.hybridd.proc[a.parentID].autoprog=!1),next(a,0,d)}function time(a,b,c){DEBUG&&console.log(" [D] ("+a.parentID+") timeout for process forced to "+(b?b+"ms":"indefinite")),"undefined"==typeof c&&(c="[time "+b+"]");for(var d,e=global.hybridd.proc[a.parentID].step;e<=global.hybridd.proc[a.parentID].steps;e++)d=a.parentID+"."+e,(global.hybridd.proc[d].timeout<b||0>=b)&&(global.hybridd.proc[d].timeout=b);for(var f=!0,g=a.processID;f;){var h=procpart(g);h[1]>-1?(f=h[0],g=f):f=!1,f&&(global.hybridd.proc[f].timeout<b||0>=b)&&(global.hybridd.proc[f].timeout=b)}next(a,0,c)}function stop(a,b,c){global.hybridd.proc[a.parentID].busy=!1,global.hybridd.proc[a.parentID].err="undefined"==typeof b?1:b,global.hybridd.proc[a.parentID].progress=1,global.hybridd.proc[a.parentID].stopped=Date.now(),global.hybridd.proc[a.parentID].data="undefined"!=typeof c?c:"[stop]",global.hybridd.proc[a.processID].busy=!1,global.hybridd.proc[a.processID].err="undefined"==typeof b?1:b,global.hybridd.proc[a.processID].progress=1,global.hybridd.proc[a.processID].stopped=Date.now(),global.hybridd.proc[a.processID].data="undefined"!=typeof c?c:"[stop]",DEBUG&&console.log(" [D] ("+a.parentID+") stopped at "+(global.hybridd.proc[a.parentID].step+1)+" of "+(global.hybridd.proc[a.parentID].steps+1))}function test(p,condition,is_true,is_false,data){DEBUG&&console.log(" [D] ("+p.parentID+") testing ["+condition+"] in step "+(global.hybridd.proc[p.parentID].step+1)+" of "+(global.hybridd.proc[p.parentID].steps+1));var result=eval(condition);return result?("undefined"==typeof data&&(data="[test T "+is_true+"]"),jump(p,is_true,data)):"undefined"==typeof is_false?("undefined"==typeof data&&(data="[test F 1]"),next(p,0,data)):("undefined"==typeof data&&(data="[test F "+is_false+"]"),jump(p,is_false,data)),!0}function poke(a,b,c,d){"undefined"==typeof d&&(d="[poke]"),DEBUG&&console.log(" [D] ("+a.parentID+") poke ["+JSON.stringify(b)+"] in step "+(global.hybridd.proc[a.parentID].step+1)+" of "+(global.hybridd.proc[a.parentID].steps+1));var e=a.processID.substring(0,a.processID.indexOf("."));return global.hybridd.proc[e].vars[b]=c,next(a,0,d),!0}functions=require("./functions"),exports.initialize=initialize,exports.init=initproc,exports.stop=stopproc,exports.fire=subqueue,exports.initproc=initproc,exports.stopproc=stopproc,exports.subqueue=subqueue,exports.procpart=procpart,jump=function(a,b,c){if("undefined"==typeof c&&(c="[jump "+b+"]"),global.hybridd.proc[a.processID].started=Date.now(),0==b&&(b=1),0>b)for(var d,e=global.hybridd.proc[a.parentID].step+b;e<global.hybridd.proc[a.parentID].step;e++)d=a.parentID+"."+e,global.hybridd.proc[d].err=0,global.hybridd.proc[d].busy=!1,global.hybridd.proc[d].progress=0,global.hybridd.proc[d].started=Date.now(),global.hybridd.proc[d].stopped=null;return global.hybridd.proc[a.parentID].busy=!1,global.hybridd.proc[a.parentID].step=global.hybridd.proc[a.parentID].step+b,global.hybridd.proc[a.processID].err=0,global.hybridd.proc[a.processID].busy=!1,global.hybridd.proc[a.processID].progress=1,global.hybridd.proc[a.processID].data=c,DEBUG&&console.log(" [D] ("+a.parentID+") jumping to step "+(global.hybridd.proc[a.parentID].step+1)+" of "+(global.hybridd.proc[a.parentID].steps+1)),global.hybridd.proc[a.processID].stopped=Date.now(),"step = step+"+b+";"},json=function(p,str){return DEBUG&&console.log(" [D] ("+p.parentID+") json ["+JSON.stringify(str)+"] in step "+(global.hybridd.proc[p.parentID].step+1)+" of "+(global.hybridd.proc[p.parentID].steps+1)),""===str&&(str="{}"),eval("{{{ var p="+str+";;; }}}"),p},peek=function(a,b){DEBUG&&console.log(" [D] ("+a.parentID+") peek ["+JSON.stringify(b)+"] in step "+(global.hybridd.proc[a.parentID].step+1)+" of "+(global.hybridd.proc[a.parentID].steps+1));var c=a.processID.substring(0,a.processID.indexOf(".")),d=null;return"undefined"!=typeof global.hybridd.proc[c].vars&&"undefined"!=typeof global.hybridd.proc[c].vars[b]&&(d=global.hybridd.proc[c].vars[b]),d};
